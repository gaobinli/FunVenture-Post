{"version":3,"file":"hotelDetail.js","sources":["../../../../../src/pages/hotel/hotelDetail.vue","../../../../../uniPage:/cGFnZXMvaG90ZWwvaG90ZWxEZXRhaWwudnVl"],"sourcesContent":["<script setup lang=\"ts\">\r\nimport { getHotelByIdAPI } from '@/services/hotel'\r\nimport type { HotelItem } from '@/types/hotel'\r\nimport { addCollectAPI } from '@/services/collect'\r\nimport { addOrderAPI } from '@/services/order'\r\nimport { getMemberProfileAPI, patchUserBalanceAPI } from '@/services/profile'\r\nimport { onLoad, onShow } from '@dcloudio/uni-app'\r\nimport { ref } from 'vue'\r\nimport { useMemberStore } from '@/stores'\r\n\r\n// 获取屏幕边界到安全区域距离\r\nconst { safeAreaInsets } = uni.getSystemInfoSync()\r\nconst memberStore = useMemberStore()\r\n// 接收页面参数\r\nconst query = defineProps<{\r\n  id: string\r\n}>()\r\n\r\nconst hotels = ref<HotelItem[]>([])\r\nconst hotel = ref<HotelItem>()\r\nconst userInfo = ref<any>(null)\r\n\r\nconst getFoodByIdData = async () => {\r\n  const res = await getHotelByIdAPI(query.id)\r\n  hotel.value = res.data\r\n  if (res.data && res.data.content) {\r\n    hotel.value.content = hotel.value.content.replace(/\\<img/gi, '<img style=\"max-width:100%;height:auto\" ')\r\n  }\r\n  hotels.value.push(hotel.value)\r\n}\r\n\r\n// 获取用户信息\r\nconst getUserInfo = async () => {\r\n  if (memberStore.profile) {\r\n    try {\r\n      const res = await getMemberProfileAPI()\r\n      userInfo.value = res.data\r\n    } catch (error) {\r\n      console.error('获取用户信息失败:', error)\r\n    }\r\n  }\r\n}\r\n\r\n// 页面加载\r\nonLoad(() => {\r\n  getFoodByIdData()\r\n  getUserInfo()\r\n})\r\n\r\n// 页面显示时刷新用户信息\r\nonShow(() => {\r\n  getUserInfo()\r\n})\r\n\r\n// 轮播图变化时\r\nconst currentIndex = ref(0)\r\nconst onchange: UniHelper.SwiperOnChange = (ev) => {\r\n  currentIndex.value = ev.detail!.current\r\n}\r\n\r\n// 点击图片时\r\nconst onTapImage = (url: string) => {\r\n  // 大图预览\r\n  uni.previewImage({\r\n    current: url,\r\n    urls: [url],\r\n  })\r\n}\r\n\r\nconst buy = async (id: number, price: number) => {\r\n  // 先检查是否登录\r\n  if (!memberStore.profile) {\r\n    uni.showToast({ icon: 'error', title: '请先登录' })\r\n    return\r\n  }\r\n\r\n  // 检查用户信息是否已加载\r\n  if (!userInfo.value) {\r\n    uni.showToast({ icon: 'error', title: '获取用户信息失败，请重试' })\r\n    return\r\n  }\r\n\r\n  const currentBalance = userInfo.value.balance || 0\r\n\r\n  // 检查余额是否足够\r\n  if (currentBalance < price) {\r\n    uni.showModal({\r\n      title: '余额不足',\r\n      content: `当前余额 ¥${currentBalance.toFixed(2)}，酒店价格 ¥${price}，需要充值 ¥${(price - currentBalance).toFixed(2)}`,\r\n      confirmText: '去充值',\r\n      cancelText: '取消',\r\n      success: (res) => {\r\n        if (res.confirm) {\r\n          // 跳转到钱包充值页面\r\n          uni.navigateTo({ url: '/pagesMember/wallet/wallet' })\r\n        }\r\n      },\r\n    })\r\n    return\r\n  }\r\n\r\n  // 余额足够，显示支付确认\r\n  uni.showModal({\r\n    content: `需要支付 ¥${price}，是否预订酒店？`,\r\n    success: async (res) => {\r\n      if (res.confirm) {\r\n        try {\r\n          // 显示加载\r\n          uni.showLoading({ title: '预订中...', mask: true })\r\n\r\n          // 调用购买接口\r\n          await addOrderAPI({ relationId: id, type: 3 })\r\n\r\n          // 购买成功，计算扣款后的余额\r\n          const newBalance = currentBalance - price\r\n\r\n          // 更新用户余额\r\n          await patchUserBalanceAPI(userInfo.value.id, newBalance)\r\n\r\n          // 更新本地用户信息\r\n          userInfo.value.balance = newBalance\r\n\r\n          uni.hideLoading()\r\n          uni.showToast({\r\n            icon: 'success',\r\n            title: '预订成功',\r\n            duration: 1500\r\n          })\r\n\r\n          // 延迟1.5秒后返回上一页\r\n          setTimeout(() => {\r\n            uni.navigateBack()\r\n          }, 1500)\r\n        } catch (error: any) {\r\n          uni.hideLoading()\r\n\r\n          // 处理异常情况，API 返回的错误信息\r\n          let errorMessage = '预订失败，请重试'\r\n\r\n          if (error?.msg) {\r\n            errorMessage = error.msg\r\n          }\r\n\r\n          // 显示错误提示给用户\r\n          uni.showToast({\r\n            icon: 'error',\r\n            title: errorMessage,\r\n            duration: 2000\r\n          })\r\n\r\n          console.error('预订失败:', {\r\n            code: error?.code,\r\n            message: errorMessage,\r\n            fullError: error\r\n          })\r\n        }\r\n      }\r\n    },\r\n  })\r\n}\r\nconst coolect = (id: number, name: string) => {\r\n  // 模态弹窗\r\n  uni.showModal({\r\n    content: '是否要收藏酒店 ' + name + ' ?',\r\n    success: (res) => {\r\n      if (res.confirm) {\r\n        console.log(\"确定了\", id)\r\n        const res = addCollectAPI({ relationId: id, type: 3 })\r\n        console.log(\"res\", res)\r\n        if (memberStore.profile) {\r\n          uni.showToast({ icon: \"success\", title: \"收藏成功\" })\r\n        }\r\n      }\r\n    },\r\n  })\r\n}\r\n\r\n</script>\r\n\r\n<template>\r\n  <scroll-view scroll-y class=\"viewport\">\r\n    <view class=\"goods\">\r\n      <view class=\"preview\">\r\n        <swiper @change=\"onchange\" circular>\r\n          <swiper-item v-for=\"item in hotels\" :key=\"item\">\r\n            <image @tap=\"onTapImage(item.url)\" mode=\"aspectFill\" :src=\"item.url\" />\r\n          </swiper-item>\r\n        </swiper>\r\n        <view class=\"indicator\">\r\n          <text class=\"current\">{{ currentIndex + 1 }}</text>\r\n          <text class=\"split\">/</text>\r\n          <text class=\"total\">1</text>\r\n        </view>\r\n      </view>\r\n      <view class=\"meta\">\r\n        <view class=\"price\">\r\n          <text class=\"number\">{{ hotel?.name }}</text>\r\n        </view>\r\n        <view class=\"name ellipsis\">{{ hotel?.shortRecommend }}</view>\r\n      </view>\r\n      <view class=\"operation\">\r\n        <view class=\"item\">\r\n          <text class=\"label\">门票</text>\r\n          <text class=\"text ellipsis\"> {{ hotel?.price }} </text>\r\n        </view>\r\n        <view class=\"item\">\r\n          <text class=\"label\">地址</text>\r\n          <text class=\"text ellipsis\"> {{ hotel?.address }} </text>\r\n        </view>\r\n        <view class=\"item\">\r\n          <text class=\"label\">来源</text>\r\n          <text class=\"text ellipsis\"> 重庆旅游平台 </text>\r\n        </view>\r\n      </view>\r\n    </view>\r\n\r\n    <view class=\"detail panel\">\r\n      <view class=\"title\">\r\n        <text>酒店详情</text>\r\n      </view>\r\n      <view class=\"content\">\r\n        <rich-text :nodes=\"hotel?.content\"></rich-text>\r\n      </view>\r\n    </view>\r\n  </scroll-view>\r\n  <!-- 用户操作 -->\r\n  <view class=\"toolbar\" :style=\"{ paddingBottom: safeAreaInsets?.bottom + 'px' }\">\r\n    <view class=\"icons\">\r\n    </view>\r\n    <view class=\"buttons\">\r\n      <view class=\"addcart\" @tap=\"buy(hotel!.id, hotel!.price)\"> 酒店预订 </view>\r\n      <view class=\"payment\" @tap=\"coolect(hotel!.id, hotel!.name)\"> 加入收藏 </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<style lang=\"scss\">\r\npage {\r\n  height: 100%;\r\n  overflow: hidden;\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n\r\n.viewport {\r\n  background-color: #f4f4f4;\r\n}\r\n\r\n.panel {\r\n  margin-top: 20rpx;\r\n  background-color: #fff;\r\n\r\n  .title {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    height: 90rpx;\r\n    line-height: 1;\r\n    padding: 30rpx 60rpx 30rpx 6rpx;\r\n    position: relative;\r\n\r\n    text {\r\n      padding-left: 10rpx;\r\n      font-size: 28rpx;\r\n      color: #333;\r\n      font-weight: 600;\r\n      border-left: 4rpx solid #27ba9b;\r\n    }\r\n\r\n    navigator {\r\n      font-size: 24rpx;\r\n      color: #666;\r\n    }\r\n  }\r\n}\r\n\r\n.arrow {\r\n  &::after {\r\n    position: absolute;\r\n    top: 50%;\r\n    right: 30rpx;\r\n    content: '\\e6c2';\r\n    color: #ccc;\r\n    font-family: 'erabbit' !important;\r\n    font-size: 32rpx;\r\n    transform: translateY(-50%);\r\n  }\r\n}\r\n\r\n.goods {\r\n  background-color: #fff;\r\n\r\n  .preview {\r\n    height: 750rpx;\r\n    position: relative;\r\n\r\n    .indicator {\r\n      height: 40rpx;\r\n      padding: 0 24rpx;\r\n      line-height: 40rpx;\r\n      border-radius: 30rpx;\r\n      color: #fff;\r\n      font-family: Arial, Helvetica, sans-serif;\r\n      background-color: rgba(0, 0, 0, 0.3);\r\n      position: absolute;\r\n      bottom: 30rpx;\r\n      right: 30rpx;\r\n\r\n      .current {\r\n        font-size: 26rpx;\r\n      }\r\n\r\n      .split {\r\n        font-size: 24rpx;\r\n        margin: 0 1rpx 0 2rpx;\r\n      }\r\n\r\n      .total {\r\n        font-size: 24rpx;\r\n      }\r\n    }\r\n  }\r\n\r\n  .meta {\r\n    position: relative;\r\n    border-bottom: 1rpx solid #eaeaea;\r\n\r\n    .price {\r\n      height: 130rpx;\r\n      padding: 25rpx 30rpx 0;\r\n      color: #fff;\r\n      font-size: 34rpx;\r\n      box-sizing: border-box;\r\n      background-color: #35c8a9;\r\n    }\r\n\r\n    .number {\r\n      font-size: 56rpx;\r\n    }\r\n\r\n    .brand {\r\n      width: 160rpx;\r\n      height: 80rpx;\r\n      overflow: hidden;\r\n      position: absolute;\r\n      top: 26rpx;\r\n      right: 30rpx;\r\n    }\r\n\r\n    .name {\r\n      max-height: 88rpx;\r\n      line-height: 1.4;\r\n      margin: 20rpx;\r\n      font-size: 32rpx;\r\n      color: #333;\r\n    }\r\n\r\n    .desc {\r\n      line-height: 1;\r\n      padding: 0 20rpx 30rpx;\r\n      font-size: 24rpx;\r\n      color: #cf4444;\r\n    }\r\n  }\r\n\r\n  .operation {\r\n    padding-left: 20rpx;\r\n\r\n    .item {\r\n      height: 90rpx;\r\n      padding-right: 60rpx;\r\n      border-bottom: 1rpx solid #eaeaea;\r\n      font-size: 26rpx;\r\n      color: #333;\r\n      position: relative;\r\n      display: flex;\r\n      align-items: center;\r\n\r\n      &:last-child {\r\n        border-bottom: 0 none;\r\n      }\r\n    }\r\n\r\n    .label {\r\n      width: 60rpx;\r\n      color: #898b94;\r\n      margin: 0 16rpx 0 10rpx;\r\n    }\r\n\r\n    .text {\r\n      flex: 1;\r\n      -webkit-line-clamp: 1;\r\n    }\r\n  }\r\n}\r\n\r\n.detail {\r\n  padding-left: 20rpx;\r\n\r\n  .content {\r\n    margin-left: -20rpx;\r\n  }\r\n\r\n  .properties {\r\n    padding: 0 20rpx;\r\n    margin-bottom: 30rpx;\r\n\r\n    .item {\r\n      display: flex;\r\n      line-height: 2;\r\n      padding: 10rpx;\r\n      font-size: 26rpx;\r\n      color: #333;\r\n      border-bottom: 1rpx dashed #ccc;\r\n    }\r\n\r\n    .label {\r\n      width: 200rpx;\r\n    }\r\n\r\n    .value {\r\n      flex: 1;\r\n    }\r\n  }\r\n}\r\n\r\n.similar {\r\n  padding-left: 20rpx;\r\n\r\n  .content {\r\n    padding: 0 20rpx 20rpx;\r\n    margin-left: -20rpx;\r\n    background-color: #f4f4f4;\r\n    overflow: hidden;\r\n\r\n    navigator {\r\n      width: 345rpx;\r\n      padding: 24rpx 20rpx 20rpx;\r\n      margin: 20rpx 20rpx 0 0;\r\n      border-radius: 10rpx;\r\n      background-color: #fff;\r\n      float: left;\r\n    }\r\n\r\n    .image {\r\n      height: 260rpx;\r\n    }\r\n\r\n    .name {\r\n      height: 80rpx;\r\n      margin: 10rpx 0;\r\n      font-size: 26rpx;\r\n      color: #262626;\r\n    }\r\n\r\n    .price {\r\n      line-height: 1;\r\n      font-size: 20rpx;\r\n      color: #cf4444;\r\n    }\r\n\r\n    .number {\r\n      font-size: 26rpx;\r\n      margin-left: 2rpx;\r\n    }\r\n  }\r\n\r\n  navigator {\r\n    &:nth-child(even) {\r\n      margin-right: 0;\r\n    }\r\n  }\r\n}\r\n\r\n.toolbar {\r\n  background-color: #fff;\r\n  height: 100rpx;\r\n  padding: 0 20rpx;\r\n  border-top: 1rpx solid #eaeaea;\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  box-sizing: content-box;\r\n\r\n  .buttons {\r\n    display: flex;\r\n\r\n    &>view {\r\n      width: 220rpx;\r\n      text-align: center;\r\n      line-height: 72rpx;\r\n      font-size: 26rpx;\r\n      color: #fff;\r\n      border-radius: 72rpx;\r\n    }\r\n\r\n    .addcart {\r\n      background-color: #ffa868;\r\n    }\r\n\r\n    .payment {\r\n      background-color: #27ba9b;\r\n      margin-left: 20rpx;\r\n    }\r\n  }\r\n\r\n  .icons {\r\n    padding-right: 10rpx;\r\n    display: flex;\r\n    align-items: center;\r\n    flex: 1;\r\n\r\n    .icons-button {\r\n      flex: 1;\r\n      text-align: center;\r\n      line-height: 1.4;\r\n      padding: 0;\r\n      margin: 0;\r\n      border-radius: 0;\r\n      font-size: 20rpx;\r\n      color: #333;\r\n      background-color: #fff;\r\n    }\r\n\r\n    text {\r\n      display: block;\r\n      font-size: 34rpx;\r\n    }\r\n  }\r\n}\r\n</style>\r\n","import MiniProgramPage from 'D:/gp/2026016-重庆旅游微信小程序的设计与实现/trip-hub-mp/src/pages/hotel/hotelDetail.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","useMemberStore","ref","getHotelByIdAPI","getMemberProfileAPI","onLoad","onShow","addOrderAPI","patchUserBalanceAPI","res","addCollectAPI"],"mappings":"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"}