{"version":3,"file":"http.js","sources":["../../../../src/utils/http.ts"],"sourcesContent":["/**\r\n * 添加拦截器\r\n *     拦截 request 请求\r\n *     拦截 uploadFile 文件上传\r\n * \r\n * TODO：\r\n *     1、非 http 开头需拼接地址\r\n *     2、请求超时\r\n *     3、添加小程序端请求头标识\r\n *     4、添加 token 请求头标识\r\n */\r\n\r\nimport { useMemberStore } from \"@/stores\"\r\n\r\nconst baseURL = 'http://127.0.0.1:9000'\r\n\r\n// 添加拦截器\r\nconst httpInterceptor = {\r\n    // 拦截前触发\r\n    invoke(options: UniApp.RequestOptions) {\r\n        // 1. 非 http 开头的拼接地址\r\n        if (!options.url.startsWith('http')) {\r\n            options.url = baseURL + options.url\r\n        }\r\n        // 2. 请求超时，默认 10s\r\n        options.timeout = 10000\r\n        // 3. 添加小程序端请求头标识\r\n        options.header = {\r\n            ...options.header,\r\n            'source-client': 'miniapp',\r\n        }\r\n        // 4.添加 token 请求标识\r\n        const memberStore = useMemberStore()\r\n        const token = memberStore.profile?.token\r\n        if (token) {\r\n            options.header.token = 'Bearer ' + token\r\n        }\r\n    }\r\n}\r\n\r\nuni.addInterceptor('request', httpInterceptor)\r\nuni.addInterceptor('uploadFile', httpInterceptor)\r\n\r\n/**\r\n * 请求函数\r\n * @param UniApp.RequestOptions\r\n * @returns Promise\r\n * \r\n * 1、返回 Promise 对象\r\n * 2、请求成功\r\n *      2.1、提取核心数据 res.data\r\n *      2.2、添加类型、支持泛型\r\n * 3、请求失败\r\n *      3.1、网络错误 -> 提示用户切换网络\r\n *      3.2、401错误 -> 清理用户信息，跳转登录页\r\n *      3.3、其他错误 -> 根据后端错误信息轻提示\r\n */\r\n// 2.2 添加类型，支持泛型\r\ninterface Data<T> {\r\n    code: string\r\n    msg: string\r\n    data: T\r\n}\r\nexport const http = <T>(options: UniApp.RequestOptions) => {\r\n    // 1、返回 Promise 对象\r\n    return new Promise<Data<T>>((resolve, reject) => {\r\n        uni.request({\r\n            ...options,\r\n            // 2、请求成功\r\n            success(res) {\r\n                // 状态码 2xx，axios 就是如此设计的\r\n                const response = res.data as Data<T>\r\n                if (response.code === '000000') {\r\n                    // 2.1、提取核心数据 res.data\r\n                    resolve(response)\r\n                } else if (response.code === '401') {\r\n                    // 401 错误 -> 清理用户信息，跳转登录页\r\n                    const memberStore = useMemberStore()\r\n                    memberStore.clearProfile()\r\n                    uni.navigateTo({ url: '/pages/login/login' })\r\n                    reject(response)\r\n                } else {\r\n                    // 其他错误 -> 返回完整响应对象，让调用方处理是否需要显示提示\r\n                    // 某些业务逻辑可能需要自己处理错误（如库存不足、余额不足等）\r\n                    reject(response)\r\n                }\r\n            },\r\n            // 响应失败\r\n            fail(err) {\r\n                uni.showToast({\r\n                    icon: 'none',\r\n                    title: '网络错误，换个网络试试'\r\n                })\r\n                reject(err)\r\n            }\r\n        })\r\n    })\r\n}"],"names":["useMemberStore","uni"],"mappings":";;;;AAcA,MAAM,UAAU;AAGhB,MAAM,kBAAkB;AAAA;AAAA,EAEpB,OAAO,SAAgC;;AAEnC,QAAI,CAAC,QAAQ,IAAI,WAAW,MAAM,GAAG;AACzB,cAAA,MAAM,UAAU,QAAQ;AAAA,IACpC;AAEA,YAAQ,UAAU;AAElB,YAAQ,SAAS;AAAA,MACb,GAAG,QAAQ;AAAA,MACX,iBAAiB;AAAA,IAAA;AAGrB,UAAM,cAAcA,sBAAAA;AACd,UAAA,SAAQ,iBAAY,YAAZ,mBAAqB;AACnC,QAAI,OAAO;AACC,cAAA,OAAO,QAAQ,YAAY;AAAA,IACvC;AAAA,EACJ;AACJ;AAEAC,cAAAA,MAAI,eAAe,WAAW,eAAe;AAC7CA,cAAAA,MAAI,eAAe,cAAc,eAAe;AAsBnC,MAAA,OAAO,CAAI,YAAmC;AAEvD,SAAO,IAAI,QAAiB,CAAC,SAAS,WAAW;AAC7CA,kBAAAA,MAAI,QAAQ;AAAA,MACR,GAAG;AAAA;AAAA,MAEH,QAAQ,KAAK;AAET,cAAM,WAAW,IAAI;AACjB,YAAA,SAAS,SAAS,UAAU;AAE5B,kBAAQ,QAAQ;AAAA,QAAA,WACT,SAAS,SAAS,OAAO;AAEhC,gBAAM,cAAcD,sBAAAA;AACpB,sBAAY,aAAa;AACzBC,wBAAAA,MAAI,WAAW,EAAE,KAAK,qBAAsB,CAAA;AAC5C,iBAAO,QAAQ;AAAA,QAAA,OACZ;AAGH,iBAAO,QAAQ;AAAA,QACnB;AAAA,MACJ;AAAA;AAAA,MAEA,KAAK,KAAK;AACNA,sBAAAA,MAAI,UAAU;AAAA,UACV,MAAM;AAAA,UACN,OAAO;AAAA,QAAA,CACV;AACD,eAAO,GAAG;AAAA,MACd;AAAA,IAAA,CACH;AAAA,EAAA,CACJ;AACL;;"}